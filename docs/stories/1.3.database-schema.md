# Story 1.3: Database Schema and Core Models

## Status
Draft

## Story

**As a** developer,
**I want** well-structured database models for users, peptides, and injections,
**so that** the application can store and retrieve tracking data efficiently.

## Acceptance Criteria

1. User model with authentication fields, profile information, and timestamps
2. Peptide model supporting both pre-configured and custom peptides with dosing information
3. Injection model capturing dose, time, injection site, peptide reference, and notes
4. Database migrations and seed data for common peptides
5. Proper foreign key relationships and data integrity constraints
6. Database indexes optimized for common query patterns (user injections, date ranges)
7. Comprehensive data validation at the database level

## Tasks / Subtasks

- [ ] Set up Supabase database connection and configuration (AC: All)
  - [ ] Install Supabase client libraries
  - [ ] Configure Supabase environment variables
  - [ ] Set up database connection utilities
  - [ ] Test basic database connectivity

- [ ] Create User table and model (AC: 1)
  - [ ] Design users table schema with Clerk integration
  - [ ] Implement user preferences JSONB field
  - [ ] Add subscription tier tracking
  - [ ] Create timestamps and audit fields
  - [ ] Set up Row Level Security (RLS) policies

- [ ] Create Peptides table and model (AC: 2)
  - [ ] Design peptides table schema
  - [ ] Implement support for custom vs pre-configured peptides
  - [ ] Add peptide category classification
  - [ ] Create dosing information JSONB fields
  - [ ] Add safety notes and Jay Campbell content links

- [ ] Create Injections table and model (AC: 3)
  - [ ] Design injections table with comprehensive tracking
  - [ ] Implement injection site tracking with rotation support
  - [ ] Add dose tracking with unit flexibility
  - [ ] Create notes and protocol reference fields
  - [ ] Set up proper foreign key relationships

- [ ] Create additional supporting tables (AC: 4, 5)
  - [ ] Create protocols table for dosing schedules
  - [ ] Create wellness_metrics table for future expansion
  - [ ] Create peptide_templates table for pre-configured peptides
  - [ ] Set up all foreign key constraints and relationships

- [ ] Implement database indexes and performance optimization (AC: 6)
  - [ ] Add indexes for user-specific queries
  - [ ] Create indexes for date range queries
  - [ ] Add indexes for peptide and injection site filtering
  - [ ] Add composite indexes for common query patterns

- [ ] Set up database validation and constraints (AC: 7)
  - [ ] Add check constraints for dose validation
  - [ ] Implement enum constraints for categories
  - [ ] Set up timestamp validation
  - [ ] Add data integrity triggers

- [ ] Create seed data and migrations (AC: 4)
  - [ ] Create initial migration files
  - [ ] Add seed data for common peptides
  - [ ] Create peptide templates with dosing information
  - [ ] Test migration rollback procedures

## Dev Notes

### Architecture References

**Database Technology:** Supabase PostgreSQL
- Robust relational database with real-time capabilities
- Built-in Row Level Security (RLS) for user data isolation
- JSONB support for flexible data structures
- Automatic API generation and real-time subscriptions

**Database Schema Design:**

**Users Table:**
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    clerk_user_id VARCHAR(255) UNIQUE NOT NULL,
    email VARCHAR(255) NOT NULL,
    preferences JSONB DEFAULT '{}',
    subscription_tier VARCHAR(20) DEFAULT 'free',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Peptides Table:**
```sql
CREATE TABLE peptides (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    is_custom BOOLEAN DEFAULT true,
    category VARCHAR(50) NOT NULL,
    typical_dose_range JSONB NOT NULL,
    safety_notes TEXT[],
    jay_content_id VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Injections Table:**
```sql
CREATE TABLE injections (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    peptide_id UUID REFERENCES peptides(id) ON DELETE CASCADE,
    dose DECIMAL(10,3) NOT NULL,
    dose_unit VARCHAR(10) NOT NULL,
    injection_site JSONB NOT NULL,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    notes TEXT,
    protocol_id UUID REFERENCES protocols(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Key Indexes:**
```sql
CREATE INDEX idx_users_clerk_id ON users(clerk_user_id);
CREATE INDEX idx_injections_user_id ON injections(user_id);
CREATE INDEX idx_injections_timestamp ON injections(timestamp);
CREATE INDEX idx_injections_user_timestamp ON injections(user_id, timestamp);
```

**Row Level Security Policies:**
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can view own data" ON users FOR ALL USING (auth.uid()::text = clerk_user_id);
```

**TypeScript Interfaces:**
```typescript
interface User {
  id: string;
  clerkUserId: string;
  email: string;
  preferences: UserPreferences;
  subscriptionTier: 'free' | 'premium' | 'expert';
  createdAt: Date;
  updatedAt: Date;
}

interface Peptide {
  id: string;
  userId: string;
  name: string;
  isCustom: boolean;
  category: PeptideCategory;
  typicalDoseRange: DoseRange;
  safetyNotes: string[];
  jayContentId: string | null;
}

interface Injection {
  id: string;
  userId: string;
  peptideId: string;
  dose: number;
  doseUnit: DoseUnit;
  injectionSite: InjectionSite;
  timestamp: Date;
  notes: string | null;
  protocolId: string | null;
}
```

**Environment Configuration:**
```bash
# Supabase Database
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
DATABASE_URL=postgresql://postgres:password@localhost:54322/postgres
```

**Migration Strategy:**
- Use Supabase migration system for version control
- Create incremental migrations for schema changes
- Include rollback procedures for each migration
- Separate data migrations from schema migrations

**Seed Data Structure:**
- Common peptides (Semaglutide, BPC-157, etc.)
- Peptide categories and typical dosing ranges
- Safety information and usage guidelines
- Jay Campbell content references where applicable

### Testing

**Database Testing Strategy:**
- Test all CRUD operations for each model
- Verify foreign key constraints and relationships
- Test RLS policies prevent cross-user data access
- Validate data integrity constraints

**Test Database Setup:**
- Use dedicated test Supabase instance
- Reset database state between tests
- Mock Clerk user IDs for testing
- Test migration up/down procedures

**Performance Testing:**
- Test query performance with large datasets
- Verify index effectiveness
- Test concurrent user scenarios
- Validate real-time subscription performance

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-29 | 1.0 | Initial story creation for database schema | Sarah (PO) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

## QA Results

*(This section will be populated by QA Agent after story completion)*