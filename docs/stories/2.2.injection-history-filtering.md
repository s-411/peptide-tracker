# Story 2.2: Injection History Table and Filtering - Brownfield Addition

## Status
Ready

## Story

**As a** peptide user,
**I want** to view and search through my complete injection history,
**so that** I can track patterns, verify doses, and maintain comprehensive records.

## Story Context

**Existing System Integration:**

- Integrates with: Injection logging system from Story 2.1, existing user authentication and database
- Technology: Next.js 15, React 19, TypeScript, Supabase PostgreSQL, existing component patterns
- Follows pattern: PeptideLibrary.tsx table/filtering approach, DatabaseService query methods
- Touch points: Injections database table, user authentication, existing filter components

## Acceptance Criteria

**Functional Requirements:**

1. Comprehensive injection history table showing date, peptide, dose, site, and notes
2. Sorting functionality for all major columns (date, peptide, dose)
3. Date range filtering to view specific time periods
4. Peptide filtering to focus on specific compounds
5. Injection site filtering to track rotation patterns
6. Text search across notes and peptide names
7. Pagination for large datasets with configurable page size
8. Mobile-responsive table design with horizontal scrolling or collapsed view

**Integration Requirements:**

4. Existing injection logging functionality from Story 2.1 continues to work unchanged
5. New functionality follows existing filtering pattern from PeptideFilters.tsx
6. Integration with DatabaseService uses established query and pagination patterns

**Quality Requirements:**

7. Change is covered by appropriate tests
8. Documentation is updated if needed
9. No regression in existing functionality verified

## Technical Notes

- **Integration Approach:** Extend DatabaseService with injection query methods, create InjectionHistory components following PeptideLibrary pattern, reuse existing filter components architecture
- **Existing Pattern Reference:** Follow PeptideLibrary.tsx for table structure, PeptideFilters.tsx for search/filter implementation, established pagination patterns
- **Key Constraints:** Must work with existing injections database schema, follow established responsive design patterns

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Table performance with large injection datasets
- **Mitigation:** Implement pagination and efficient database queries following existing patterns
- **Rollback:** Remove new injection history routes and components

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs
- [ ] Database changes (if any) are additive only - using existing injections table queries
- [ ] UI changes follow existing design patterns from peptide management
- [ ] Performance impact is controlled through pagination

## Tasks / Subtasks

- [ ] Extend DatabaseService with injection history queries
  - [ ] Add getUserInjections method with filtering support
  - [ ] Implement date range, peptide, and injection site filtering
  - [ ] Add pagination support with configurable page size
  - [ ] Create text search functionality across notes and peptide names

- [ ] Create injection history table component
  - [ ] Build InjectionHistoryTable following existing table patterns
  - [ ] Implement column sorting for date, peptide, dose
  - [ ] Add mobile-responsive design with collapsible columns
  - [ ] Include pagination controls

- [ ] Create injection history filters component
  - [ ] Build InjectionFilters following PeptideFilters pattern
  - [ ] Add date range picker component
  - [ ] Implement peptide and injection site filter dropdowns
  - [ ] Add text search input with debouncing

- [ ] Create injection history page and navigation
  - [ ] Create /injections/history page following existing page structure
  - [ ] Add navigation integration to dashboard and injection logging
  - [ ] Implement loading states and empty state handling

## Dev Notes

### Architecture References

**Component Architecture:**
- Follow PeptideLibrary.tsx structure for main history component
- Reuse PeptideFilters.tsx pattern for injection filtering
- Follow established table and pagination patterns

**Database Integration:**
- Extend existing DatabaseService with injection query methods
- Use existing injections table with JOIN to peptides for display
- Follow established filtering and pagination patterns

**Filter Structure:**
```typescript
interface InjectionFilters {
  dateRange?: DateRange;
  peptideId?: string;
  injectionSite?: InjectionLocation;
  search?: string;
}
```

**Table Columns:**
- Date/Time (sortable, primary)
- Peptide Name (sortable, with category)
- Dose (sortable, with unit)
- Injection Site (filterable)
- Notes (searchable, truncated)
- Actions (edit/delete links)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-29 | 1.0 | Initial story creation for injection history and filtering | John (PM) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

## QA Results

*(This section will be populated by QA Agent after story completion)*