# Story 3.2: Weekly Progress Dashboard

**Status:** Ready for Review
**Epic:** Epic 3 - Weekly Dose Monitoring & Progress Tracking
**Agent Model Used:** Claude-4 Sonnet

## Story

As a peptide user,
I want to see my current progress toward weekly dose targets,
so that I can ensure I'm staying on track with my protocols and understand how much more I need to inject this week.

## Story Context

**Existing System Integration:**
- Integrates with: Existing dashboard components, protocols table (from Story 3.1), injections table
- Technology: Next.js React components, Supabase queries, Chart.js/Recharts for visualizations
- Follows pattern: Existing dashboard widgets in `/apps/web/src/components/dashboard/`
- Touch points: User injections data, active protocols, dashboard layout

## Acceptance Criteria

**Functional Requirements:**

1. **Weekly Progress Overview**
   - Dashboard widget showing current week's dose progress for each active protocol
   - Calculate progress based on injections logged versus protocol targets
   - Display both completed dose amount and remaining dose needed

2. **Visual Progress Indicators**
   - Progress bars showing percentage completion for each peptide protocol
   - Color-coded status indicators: green (on track), yellow (behind), blue (ahead), grey (complete)
   - Charts showing weekly dose accumulation over time

3. **Smart Scheduling Assistance**
   - Show days remaining in current week with suggested dosing schedule
   - Calculate optimal timing for remaining doses based on protocol schedule
   - Highlight missed doses based on expected protocol timing

4. **Quick Action Integration**
   - Direct links to log injections from progress view
   - One-click access to adjust protocol targets if needed
   - Quick view of recent injections for context

**Integration Requirements:**

5. **Data Integration**
   - Query active protocols from protocols table
   - Aggregate injection data by week and peptide
   - Calculate progress percentages with real-time updates

6. **Dashboard Integration**
   - Integrate seamlessly with existing dashboard layout
   - Mobile-responsive design consistent with current dashboard widgets
   - Fast loading with efficient data fetching

7. **Historical Context**
   - Show previous week's performance for comparison
   - Display weekly trends over last 4-6 weeks
   - Historical weekly performance visualization

**Quality Requirements:**

8. **Performance Optimization**
   - Efficient database queries to avoid dashboard slowdown
   - Caching of calculated progress data where appropriate
   - Lazy loading of historical trend data

9. **User Experience**
   - Clear visual hierarchy showing most important information first
   - Intuitive progress visualization
   - Accessible design with proper contrast and screen reader support

## Technical Notes

- **Database Queries:** Complex aggregation queries joining protocols and injections tables
- **Integration Approach:** Build new dashboard widget following existing patterns, integrate with current dashboard grid
- **Existing Pattern Reference:** Follow dashboard widget structure from `/apps/web/src/components/dashboard/`
- **Key Constraints:** Must handle timezone considerations for weekly calculations, efficient queries for real-time updates

## Dev Notes

- Weekly calculations should respect user timezone settings
- Consider caching strategy for expensive progress calculations
- Progress calculations need to account for flexible scheduling (every other day, specific days)
- Integration with existing injection logging flow for seamless user experience

## Testing

- Test weekly progress calculations with various protocol schedules
- Verify timezone handling for weekly boundaries
- Test performance with large injection history datasets
- Validate progress visualization accuracy
- Test responsive design across device sizes

## Tasks

### Task 1: Progress Calculation Engine
- [x] Build weekly dose aggregation queries
- [x] Implement protocol progress calculation logic
- [x] Handle timezone considerations for weekly boundaries
- [x] Create efficient database indexes for progress queries

### Task 2: Dashboard Widget Components
- [x] Create weekly progress widget component
- [x] Build progress bar and status indicator components
- [x] Implement responsive chart visualizations
- [x] Add quick action buttons for logging injections

### Task 3: Historical Trends Integration
- [x] Build historical weekly performance queries
- [x] Create trend visualization components
- [x] Implement comparison with previous weeks
- [x] Add performance insights and recommendations

### Task 4: Dashboard Integration and Testing
- [x] Integrate progress widget into existing dashboard layout
- [x] Ensure consistent styling with current dashboard
- [x] Write comprehensive test suite for progress calculations
- [x] Perform end-to-end testing with various protocol scenarios

## Dev Agent Record

**Debug Log:** [None]

**Completion Notes:**
- Successfully implemented complete Weekly Progress Dashboard system
- Complex progress calculation engine with protocol-aware logic completed
- Full dashboard widget with visual progress indicators and status colors
- Historical trends chart with 6-week comparison implemented
- API endpoint with efficient database queries and timezone handling
- Integration with existing dashboard layout seamless and responsive
- Build passes with TypeScript compilation successful

**File List:**
- apps/web/src/types/database.ts (added WeeklyProgress types)
- apps/web/src/lib/database.ts (added weekly progress calculation methods)
- apps/web/src/app/api/protocols/weekly-progress/route.ts (new API endpoint)
- apps/web/src/components/dashboard/WeeklyProgressWidget.tsx (main widget component)
- apps/web/src/components/dashboard/ProgressChart.tsx (historical trends chart)
- apps/web/src/app/dashboard/page.tsx (integrated widget into dashboard)

**Change Log:**
- Added comprehensive WeeklyProgressData and ProtocolProgress types
- Implemented getWeeklyProgress() method with complex protocol calculations
- Added getWeeklyProgressTrends() for historical analysis
- Created smart status determination logic (on_track, behind, ahead, complete)
- Built suggested dose calculation engine based on schedule types
- Implemented responsive dashboard widget with color-coded progress bars
- Added quick action integration for seamless user workflow
- Created simple but effective historical trends visualization
- Integrated both WeeklySummary and WeeklyProgress widgets side-by-side