# Story 2.3: Injection Detail and Edit Capabilities - Brownfield Addition

## Status
Ready

## Story

**As a** peptide user,
**I want** to view detailed information about specific injections and correct any logging mistakes,
**so that** I can maintain accurate records and fix data entry errors.

## Story Context

**Existing System Integration:**

- Integrates with: Injection logging from Story 2.1, injection history from Story 2.2, existing CRUD patterns
- Technology: Next.js 15, React 19, TypeScript, Supabase PostgreSQL, existing form validation
- Follows pattern: PeptideDetail.tsx and PeptideForm.tsx for detail views and editing
- Touch points: Injections database table, existing DatabaseService update/delete methods

## Acceptance Criteria

**Functional Requirements:**

1. Injection detail view showing complete information including timestamps
2. Edit injection functionality preserving data integrity and audit trail
3. Delete injection capability with confirmation dialog and soft delete option
4. Validation preventing future-dated injections or unrealistic dose amounts
5. Change tracking showing when injections were modified and by whom
6. Bulk selection and operations for managing multiple injections
7. Injection duplication feature for repeated protocols

**Integration Requirements:**

4. Existing injection logging and history functionality continues to work unchanged
5. New functionality follows existing detail view pattern from PeptideDetail.tsx
6. Integration with DatabaseService uses established update/delete patterns

**Quality Requirements:**

7. Change is covered by appropriate tests
8. Documentation is updated if needed
9. No regression in existing functionality verified

## Technical Notes

- **Integration Approach:** Create InjectionDetail and InjectionEditForm components following PeptideDetail/PeptideForm patterns, extend DatabaseService with update/delete methods
- **Existing Pattern Reference:** Follow PeptideDetail.tsx for detail view layout, PeptideForm.tsx for edit form structure, existing confirmation dialogs for delete operations
- **Key Constraints:** Must preserve data integrity, follow established audit trail patterns, maintain consistency with existing UI patterns

## Definition of Done

- [ ] Functional requirements met
- [ ] Integration requirements verified
- [ ] Existing functionality regression tested
- [ ] Code follows existing patterns and standards
- [ ] Tests pass (existing and new)
- [ ] Documentation updated if applicable

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Data integrity during edit operations and audit trail implementation
- **Mitigation:** Follow existing update patterns from DatabaseService, implement proper validation, use soft delete for safety
- **Rollback:** Remove new detail/edit routes and components, database has audit fields

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs
- [ ] Database changes use existing updated_at fields for audit trail
- [ ] UI changes follow existing detail view and form patterns
- [ ] Performance impact is minimal - similar to existing peptide operations

## Tasks / Subtasks

- [ ] Extend DatabaseService with injection update/delete operations
  - [ ] Add updateInjection method following existing update patterns
  - [ ] Add deleteInjection method with soft delete option
  - [ ] Implement injection duplication functionality
  - [ ] Add bulk operations support for multiple injection management

- [ ] Create injection detail view component
  - [ ] Build InjectionDetail following PeptideDetail pattern
  - [ ] Display complete injection information with timestamps
  - [ ] Add edit and delete action buttons
  - [ ] Include change tracking display

- [ ] Create injection edit form component
  - [ ] Build InjectionEditForm following PeptideForm pattern
  - [ ] Implement validation preventing future dates and unrealistic doses
  - [ ] Add confirmation for significant changes
  - [ ] Include audit trail preservation

- [ ] Create injection detail page and routing
  - [ ] Create /injections/[id] page following existing detail page structure
  - [ ] Create /injections/[id]/edit page for edit functionality
  - [ ] Add navigation integration from history table
  - [ ] Implement bulk selection UI in history table

- [ ] Add confirmation dialogs and user feedback
  - [ ] Create delete confirmation dialog with soft delete option
  - [ ] Add duplicate injection confirmation
  - [ ] Implement success/error feedback for all operations

## Dev Notes

### Architecture References

**Component Architecture:**
- Follow PeptideDetail.tsx structure for injection detail view
- Reuse PeptideForm.tsx patterns for injection edit form
- Follow established modal/dialog patterns for confirmations

**Database Integration:**
- Extend existing DatabaseService with injection update/delete methods
- Use existing audit trail fields (updated_at timestamps)
- Follow established validation patterns

**Route Structure:**
```
/injections/[id]           # Injection detail view
/injections/[id]/edit      # Edit injection form
/injections/history        # History table with bulk actions
```

**Edit Form Validation:**
```typescript
interface InjectionEditValidation {
  timestamp: Date;           // Cannot be future-dated
  dose: number;              // Must be within realistic range
  doseUnit: string;          // Must match peptide typical units
  injectionSite: InjectionSite; // Must be valid site
}
```

**Bulk Operations:**
- Select multiple injections in history table
- Bulk delete with confirmation
- Bulk duplicate for repeated protocols
- Export selected injections

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-29 | 1.0 | Initial story creation for injection detail and edit capabilities | John (PM) |

## Dev Agent Record

*(This section will be populated by the development agent during implementation)*

### Agent Model Used
*(To be filled by dev agent)*

### Debug Log References
*(To be filled by dev agent)*

### Completion Notes List
*(To be filled by dev agent)*

### File List
*(To be filled by dev agent)*

## QA Results

*(This section will be populated by QA Agent after story completion)*